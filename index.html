<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>文件下载入口</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:720px;margin:40px auto;padding:0 16px}
    label{display:block;margin:12px 0 6px}
    input{width:100%;padding:10px 12px;font-size:16px}
    button{margin-top:16px;padding:10px 14px;font-size:16px;cursor:pointer}
    .hint{margin-top:12px;color:#666;line-height:1.6}
    .err{margin-top:12px;color:#b00020;white-space:pre-wrap}
  </style>
</head>
<body>
  <h2>文件下载入口</h2>

  <label>姓名</label>
  <input id="name" placeholder="例如：郑国华" />

  <label>身份证后 6 位</label>
  <input id="id_last6" placeholder="例如：280060" inputmode="numeric" />

  <button id="btn">查询并下载</button>

  <div class="hint">说明：点击后先向云函数请求签名下载链接，再跳转到 COS 下载。</div>
  <div id="err" class="err"></div>

<script>
  const FUNCTION_URL = "https://1393295782-kaq5wbwcvq.ap-shanghai.tencentscf.com".replace(/\/+$/, "");
  const $ = (id) => document.getElementById(id);

  $("btn").addEventListener("click", async () => {
    $("err").textContent = "";

    const name = $("name").value.trim();
    const id_last6 = $("id_last6").value.trim();

    if (!name || !id_last6) return $("err").textContent = "请填写姓名和身份证后6位";
    if (!/^\d{6}$/.test(id_last6)) return $("err").textContent = "身份证后6位应为6位数字";

    const params = new URLSearchParams({ name, id_last6, _ts: Date.now().toString() });
    const api = `${FUNCTION_URL}?${params.toString()}`;

    try {
      const resp = await fetch(api, { method: "GET", cache: "no-store" });
      const data = await resp.json().catch(() => null);

      if (!data || !data.ok) {
        $("err").textContent = `查询失败：${data ? (data.msg || data.error || JSON.stringify(data)) : "无法解析响应"}`;
        return;
      }
      // 跳转到 COS 预签名 URL
      window.location.href = data.url;
    } catch (e) {
      $("err").textContent = `请求失败：${e && e.message ? e.message : String(e)}`;
    }
  });
</script>
</body>
</html>
